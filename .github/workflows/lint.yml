name: Linter

on:
  push:
    branches: [ "main" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]


jobs:
  eslint:
    name: Run eslint scanning on ${{ matrix.bundle }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix: 
        bundle: ["client", "server"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref:  ${{ github.event.pull_request.head.sha }}

      - name: Install ESLint
        working-directory: ${{ matrix.bundle }}
        run: |
          npm install eslint --save-dev globals @eslint/js typescript-eslint eslint
      - name: extra-client-installation
        working-directory: client
        if: ${{ matrix.bundle == 'client' }}
        run: |
          npm install --save-dev eslint-plugin-react eslint-plugin-react-refresh eslint-plugin-react-hooks 
      - name: Run ESLint on ${{ matrix.bundle }}
        working-directory: ${{ matrix.bundle }}
        id: lint
        run: |
          git branch --show-current
          if ! npx eslint . -o "output.txt"; then
            echo "failed=true" >> $GITHUB_OUTPUT
          else 
            echo "failed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      - name: see output
        run: |
          if [[ "${{ steps.lint.outputs.failed }}" =~ 'true' ]]; then
            echo "# ${{ matrix.bundle }} Lint failed ❌" >> $GITHUB_STEP_SUMMARY
            exit 1;
          fi
          echo "# ${{ matrix.bundle }} Lint result:" >> $GITHUB_STEP_SUMMARY
          if [[ -f "output.txt" ]]; then
            cat output.txt >> $GITHUB_STEP_SUMMARY 
            exit 1;
          else
            echo "Linter finished with no errors :rocket:" >> $GITHUB_STEP_SUMMARY
          fi